name: Build and Release

on:
    push:
        tags:
            - "v*.*.*"
    workflow_dispatch:

jobs:
    build-backend:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                goos: [linux, windows, darwin]
                goarch: [amd64, arm64]
        name: Build Go backend (${{ matrix.goos }}-${{ matrix.goarch }})
        steps:
            - uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v4
              with:
                  go-version: "1.21"
            - name: Build binary
              working-directory: backend
              run: |
                  mkdir -p dist &&
                  GOARCH=${{ matrix.goarch }} GOOS=${{ matrix.goos }} go build \
                  -ldflags "-X 'leetcode-rich-presence/internal/config.DefaultClientID=${{ secrets.DISCORD_CLIENT_ID }}'" \
                  -o dist/backend-${{ matrix.goos }}-${{ matrix.goarch }} ./main.go

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: backend-${{ matrix.goos }}-${{ matrix.goarch }}
                  path: backend/dist/backend-${{ matrix.goos }}-${{ matrix.goarch }}

    build-extension:
        runs-on: ubuntu-latest
        name: Build Web Extension
        strategy:
            matrix:
                node-version: [20]
        steps:
            - uses: actions/checkout@v4

            - name: Install pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 10

            - name: Use Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: extension/pnpm-lock.yaml

            - name: Install dependencies
              run: pnpm install
              working-directory: extension

            - name: Build Extension
              run: pnpm run publish
              working-directory: extension

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: extension.zip
                  path: extension/extension.zip

    release:
        needs: [build-backend, build-extension]
        runs-on: ubuntu-latest
        steps:
            - uses: actions/download-artifact@v5
              with:
                  path: artifacts

            - name: List artifacts
              run: ls -R artifacts

            - name: Prepare release assets
              run: |
                  mkdir release-assets
                  cp artifacts/backend-*/* release-assets/ || true
                  cp artifacts/extension release-assets/ || true

            - name: Create Release
              uses: softprops/action-gh-release@v2
              with:
                  files: release-assets/*
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
